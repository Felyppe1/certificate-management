datasource db {
    provider  = "postgresql"
    url       = env("DB_URL")
    directUrl = env("DB_DIRECT_URL")
}

generator client {
    provider = "prisma-client"
    output   = "client"
}

model User {
    id            String  @id @default(cuid())
    email         String  @unique
    name          String
    password_hash String?

    Session             Session[]
    ExternalUserAccount ExternalUserAccount[]

    CertificateEmission CertificateEmission[]

    @@map("users")
}

model Session {
    token   String @id
    user_id String

    User User @relation(fields: [user_id], references: [id])

    @@map("sessions")
}

model ExternalUserAccount {
    user_id          String
    provider         String // "GOOGLE" | "GITHUB" | "FACEBOOK" | ...
    provider_user_id String

    access_token                  String
    refresh_token                 String?
    access_token_expiry_datetime  DateTime?
    refresh_token_expiry_datetime DateTime?

    User User @relation(fields: [user_id], references: [id])

    @@id([user_id, provider])
    @@unique([provider, provider_user_id])
    @@map("external_user_accounts")
}

model CertificateEmission {
    id         String   @id @default(cuid())
    title      String
    status     String // "DRAFT" | "EMITTED" | "SCHEDULED"
    created_at DateTime @default(now())

    user_id String

    User                         User                           @relation(fields: [user_id], references: [id])
    Template                     Template?
    DataSource                   DataSource?
    Email                        Email?
    CertificateGenerationHistory CertificateGenerationHistory[]

    @@map("certificate_emissions")
}

model Template {
    certificate_emission_id String @id

    drive_file_id    String?
    storage_file_url String?
    thumbnail_url    String?
    file_name        String
    input_method     String // "URL" | "GOOGLE_DRIVE" | "UPLOAD"
    file_extension   String

    TemplateVariable    TemplateVariable[]
    CertificateEmission CertificateEmission @relation(fields: [certificate_emission_id], references: [id])

    @@map("templates")
}

model TemplateVariable {
    template_id String
    name        String

    data_source_id   String?
    data_source_name String?

    Template         Template          @relation(fields: [template_id], references: [certificate_emission_id], onDelete: Cascade)
    DataSourceColumn DataSourceColumn? @relation(fields: [data_source_id, data_source_name], references: [data_source_id, name])

    @@id([name, template_id])
    @@unique([data_source_id, data_source_name])
    @@map("template_variables")
}

model DataSource {
    certificate_emission_id String @id

    drive_file_id    String?
    storage_file_url String?
    thumbnail_url    String?
    file_name        String
    input_method     String // "URL" | "GOOGLE_DRIVE" | "UPLOAD"
    file_extension   String

    DataSourceColumn    DataSourceColumn[]
    CertificateEmission CertificateEmission @relation(fields: [certificate_emission_id], references: [id])
    DataSet             DataSet?

    @@map("data_sources")
}

model DataSourceColumn {
    data_source_id String
    name           String

    DataSource       DataSource        @relation(fields: [data_source_id], references: [certificate_emission_id], onDelete: Cascade)
    TemplateVariable TemplateVariable?

    @@id([name, data_source_id])
    @@map("data_source_columns")
}

model DataSet {
    id                String  @id @default(cuid())
    generation_status String? // "PENDING" | "COMPLETED" | "FAILED"
    total_bytes       Int
    rows              Json

    certificate_emission_id String @unique

    DataSource DataSource @relation(fields: [certificate_emission_id], references: [certificate_emission_id], onDelete: Cascade)

    @@map("data_sets")
}

model Email {
    id               String    @id @default(cuid())
    subject          String?
    body             String?
    scheduled_at     DateTime?
    status           String // "PENDING" | "RUNNING" | "COMPLETED" | "FAILED"
    email_error_type String?

    certificate_emission_id String  @unique
    email_column            String?

    CertificateEmission    CertificateEmission      @relation(fields: [certificate_emission_id], references: [id])
    EmailGenerationHistory EmailGenerationHistory[]

    @@map("emails")
}

model EmailGenerationHistory {
    email_id   String
    quantity   Int
    created_at DateTime @default(now())

    Email Email @relation(fields: [email_id], references: [id])

    @@map("email_generation_histories")
    @@id([email_id, created_at])
}

model CertificateGenerationHistory {
    certificate_emission_id String
    quantity                Int
    created_at              DateTime @default(now())

    CertificateEmission CertificateEmission @relation(fields: [certificate_emission_id], references: [id])

    @@map("certificate_generation_histories")
    @@id([certificate_emission_id, created_at])
}

model Outbox {
    id         String   @id @default(cuid())
    event_type String
    payload    Json
    processed  Boolean  @default(false)
    created_at DateTime @default(now())
    updated_at DateTime @updatedAt

    @@map("outbox")
}
